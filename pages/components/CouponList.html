<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Coupons — Admin (Themed)</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --primary-color: #607274;
      --accent-bg: #edeae2;
      --muted: #6c757d;
      --card-bg: #ffffff;
      --danger: #dc3545;
    }

    html, body {
      height: 100%;
      background: var(--accent-bg);
      color: var(--primary-color);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin: 0;
      padding: 0;
    }

    .app-shell { min-height: 100%; display: flex; flex-direction: column; }
    .container-full { margin: 2.25rem auto; width: calc(100% - 48px); }
    h1 { font-weight: 600; color: var(--primary-color); }

    .card {
      border: 1px solid rgba(96,114,116,0.08);
      box-shadow: 0 6px 18px rgba(96,114,116,0.06);
      background: var(--card-bg);
      border-radius: 12px;
    }

    .btn-primary-custom { background: var(--primary-color); color: white; border: none; }
    .btn-outline-primary-custom { background: transparent; color: var(--primary-color); border: 1px solid var(--primary-color);}
    .btn-outline-primary-custom:hover{ background-color: var(--primary-color); color: var(--card-bg);}
    .btn-danger-custom { background: #ff6b6b; color: white; border: none; }
    .btn-danger-custom:hover{ background-color: transparent; border: 1px solid #ff6b6b; color: #ff6b6b; }

    .small-muted { font-size: .9rem; color: var(--muted); }

    .table thead th { vertical-align: middle; color: var(--primary-color); }
    .table tbody td { vertical-align: middle; color: #222; }

    .badge-active { background: linear-gradient(180deg, rgba(96,114,116,0.12), rgba(96,114,116,0.06)); color: var(--primary-color); border-radius: 999px; padding: .35rem .6rem; font-weight: 600; }
    .badge-inactive { background: #e9ecef; color: #6b6f74; border-radius: 999px; padding: .35rem .6rem; font-weight: 600; }

    .form-check.custom-check { --size: 18px; display: inline-flex; align-items: center; gap: .5rem; cursor: pointer; user-select: none; }
    .custom-check input[type="checkbox"]{
      appearance: none; -webkit-appearance: none; width: var(--size); height: var(--size); border-radius: 6px; border: 2px solid var(--primary-color); background: transparent; display: inline-block; position: relative; transition: background .15s, border-color .15s, transform .08s; margin: 0;
    }
    .custom-check input[type="checkbox"]:focus{ outline: 3px solid rgba(96,114,116,0.12); outline-offset: 2px; }
    .custom-check input[type="checkbox"]:checked{ background: var(--primary-color); border-color: var(--primary-color); }
    .custom-check input[type="checkbox"]:checked::after{ content: ""; position: absolute; left: 4px; top: 1px; width: 6px; height: 11px; border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg); }
    .select-all-checkbox input[type="checkbox"]{ width: 20px; height: 20px; }

    @media (max-width: 760px) {
      .desktop-only { display: none; }
      .container-full { width: calc(100% - 24px); margin: 1rem auto; }
    }

    .footer-actions { margin-top: 1rem; display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap; }
    .form-control.custom { border: 1px solid rgba(96,114,116,0.12); box-shadow: none; border-radius: 8px; }
    .btn-sm { padding: .25rem .5rem; border-radius: 6px; }
  </style>
</head>
<body>
<div class="app-shell">
  <div class="container-full">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h3 class="mb-0">Coupons</h3>
      <div class="d-flex gap-2">
        <button id="exportCSVBtn" class="btn btn-outline-primary-custom">Export CSV</button>
      </div>
    </div>

    <!-- Controls -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="row g-2 align-items-center">
          <div class="col-md-6">
            <input id="searchInput" class="form-control custom" placeholder="Search by code or description...">
          </div>

          <div class="col-md-2">
            <select id="statusFilter" class="form-select custom">
              <option value="all">All status</option>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>

          <div class="col-md-2">
            <select id="perPage" class="form-select custom">
              <option value="5">5 / page</option>
              <option value="10" selected>10 / page</option>
              <option value="20">20 / page</option>
            </select>
          </div>

          <div class="col-md-2 d-flex justify-content-end align-items-center gap-2">
            <small class="small-muted">Sort:</small>
            <select id="sortSelect" class="form-select custom w-auto">
              <option value="code:asc">Code ↑</option>
              <option value="code:desc">Code ↓</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="card">
      <div class="card-body p-0 overflow-auto">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width:48px;">
                <label class="form-check custom-check select-all-checkbox" title="Select all">
                  <input id="selectAll" type="checkbox">
                </label>
              </th>
              <th>Code</th>
              <th>Discount</th>
              <th class="desktop-only">Start Date</th>
              <th class="desktop-only">End Date</th>
              <th>Status</th>
              <th style="width:150px">Actions</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Footer actions + pagination -->
    <div class="footer-actions">
      <div class="d-flex align-items-center gap-2">
        <button id="bulkDeleteBtn" class="btn btn-danger-custom">Delete Selected</button>
        <div id="resultCount" class="small-muted">0 results</div>
      </div>

      <div class="d-flex align-items-center gap-2">
        <button id="prevPage" class="btn btn-outline-primary-custom btn-sm">Prev</button>
        <div id="pageInfo" class="px-2 small-muted">Page 1 / 1</div>
        <button id="nextPage" class="btn btn-outline-primary-custom btn-sm">Next</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Coupon Modal -->
<div class="modal fade" id="editCouponModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Coupon</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editCouponForm">
          <div class="mb-3">
            <label for="editCode" class="form-label">Code</label>
            <input type="text" class="form-control" id="editCode">
          </div>
          <div class="mb-3">
            <label for="editDiscount" class="form-label">Discount</label>
            <input type="text" class="form-control" id="editDiscount">
          </div>
          <div class="mb-3">
            <label for="editDescription" class="form-label">Description</label>
            <textarea class="form-control" id="editDescription"></textarea>
          </div>
          <div class="row g-2">
            <div class="col-md-6">
              <label for="editStartDate" class="form-label">Start Date</label>
              <input type="date" class="form-control" id="editStartDate">
            </div>
            <div class="col-md-6">
              <label for="editEndDate" class="form-label">End Date</label>
              <input type="date" class="form-control" id="editEndDate">
            </div>
          </div>
          <div class="mt-3">
            <label class="form-label">Status</label>
            <select class="form-select" id="editStatus">
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveEditBtn">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS & Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
let coupons = [
  { id: 'CUP-001', code: 'FLAT100', discount:'CA$100', startDate: '2024-12-31', endDate: '2025-12-30', isActive: true, description: 'Flat CA$100 off on orders above CA$1000' },
  { id: 'CUP-002', code: 'SUMMER25', discount:'25%', startDate: '2025-05-31', endDate: '2025-09-29', isActive: true, description: 'Summer collection discount' },
  { id: 'CUP-003', code: 'WELCOME10', discount:'10%', startDate: '2023-12-31', endDate: '2026-12-30', isActive: false, description: 'New customer coupon' }
];

let query = '', statusFilter = 'all', perPage = 10, currentPage = 1, sortBy = { key: 'code', dir: 'asc' }, selectedIds = new Set();

const tableBody = document.getElementById('tableBody');
const searchInput = document.getElementById('searchInput');
const statusFilterEl = document.getElementById('statusFilter');
const perPageEl = document.getElementById('perPage');
const sortSelect = document.getElementById('sortSelect');
const resultCount = document.getElementById('resultCount');
const pageInfo = document.getElementById('pageInfo');
const prevPageBtn = document.getElementById('prevPage');
const nextPageBtn = document.getElementById('nextPage');
const selectAll = document.getElementById('selectAll');
const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
const exportCSVBtn = document.getElementById('exportCSVBtn');

function formatDate(d) {
  if(!d) return '—';
  const dt = new Date(d);
  if (isNaN(dt)) return d;
  return (dt.getMonth()+1) + '/' + dt.getDate() + '/' + dt.getFullYear();
}

function getFilteredSorted(){
  const q = query.trim().toLowerCase();
  let arr = coupons.filter(c => {
    if(statusFilter==='active' && !c.isActive) return false;
    if(statusFilter==='inactive' && c.isActive) return false;
    if(!q) return true;
    return c.code.toLowerCase().includes(q) || (c.description && c.description.toLowerCase().includes(q));
  });

  arr.sort((a,b)=>{
    const k=sortBy.key; const dir=sortBy.dir==='asc'?1:-1;
    const A=(a[k]||'').toString().toLowerCase();
    const B=(b[k]||'').toString().toLowerCase();
    if(A<B) return -1*dir; if(A>B) return 1*dir; return 0;
  });
  return arr;
}

function renderTable(){
  const arr = getFilteredSorted();
  const total = arr.length;
  const totalPages = Math.max(1, Math.ceil(total/perPage));
  if(currentPage>totalPages) currentPage=totalPages;

  const start=(currentPage-1)*perPage;
  const visible=arr.slice(start,start+perPage);

  tableBody.innerHTML='';
  if(visible.length===0){
    tableBody.innerHTML='<tr><td colspan="7" class="text-center py-4 text-muted">No coupons found.</td></tr>';
  } else {
    visible.forEach(c=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>
          <label class="form-check custom-check" title="Select">
            <input class="row-select" data-id="${c.id}" type="checkbox" ${selectedIds.has(c.id)?'checked':''}>
          </label>
        </td>
        <td><div class="fw-semibold">${escapeHtml(c.code)}</div></td>
        <td>${escapeHtml(c.discount||'—')}</td>
        <td class="desktop-only">${formatDate(c.startDate)}</td>
        <td class="desktop-only">${formatDate(c.endDate)}</td>
        <td><span class="${c.isActive?'badge-active':'badge-inactive'} badge-status" data-id="${c.id}">${c.isActive?'Active':'Inactive'}</span></td>
        <td>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-primary-custom btn-edit" data-id="${c.id}">Edit</button>
            <button class="btn btn-sm btn-danger-custom btn-delete" data-id="${c.id}">Delete</button>
          </div>
        </td>
      `;
      tableBody.appendChild(tr);
    });
  }

  document.querySelectorAll('.row-select').forEach(el=>el.addEventListener('change',e=>{
    const id=e.target.dataset.id;
    e.target.checked?selectedIds.add(id):selectedIds.delete(id);
    updateSelectAllCheckbox();
  }));

  document.querySelectorAll('.btn-delete').forEach(b=>b.addEventListener('click',()=> {
    const id=b.dataset.id;
    if(confirm('Delete this coupon?')){ coupons=coupons.filter(c=>c.id!==id); selectedIds.delete(id); renderTable(); }
  }));

  // edit modal
  document.querySelectorAll('.btn-edit').forEach(b=>{
    b.addEventListener('click',()=>{
      const id=b.dataset.id;
      const coupon = coupons.find(c=>c.id===id);
      if(!coupon) return;
      document.getElementById('editCode').value = coupon.code;
      document.getElementById('editDiscount').value = coupon.discount || '';
      document.getElementById('editDescription').value = coupon.description||'';
      document.getElementById('editStartDate').value = coupon.startDate;
      document.getElementById('editEndDate').value = coupon.endDate;
      document.getElementById('editStatus').value = coupon.isActive ? 'active' : 'inactive';

      const modal = new bootstrap.Modal(document.getElementById('editCouponModal'));
      modal.show();
      document.getElementById('saveEditBtn').onclick = ()=>{
        coupon.code = document.getElementById('editCode').value;
        coupon.discount = document.getElementById('editDiscount').value;
        coupon.description = document.getElementById('editDescription').value;
        coupon.startDate = document.getElementById('editStartDate').value;
        coupon.endDate = document.getElementById('editEndDate').value;
        coupon.isActive = document.getElementById('editStatus').value==='active';
        renderTable();
        modal.hide();
      };
    });
  });

  document.querySelectorAll('.badge-status').forEach(b=>{
    b.addEventListener('click',()=>{
      const id=b.dataset.id;
      coupons = coupons.map(c=>c.id===id?{...c,isActive:!c.isActive}:c);
      renderTable();
    });
  });

  resultCount.textContent=`${total} results`;
  pageInfo.textContent=`Page ${currentPage} / ${totalPages}`;
  prevPageBtn.disabled = currentPage<=1;
  nextPageBtn.disabled = currentPage>=totalPages;
  updateSelectAllCheckbox();
}

function updateSelectAllCheckbox(){
  const checkboxes = Array.from(document.querySelectorAll('.row-select'));
  if(checkboxes.length===0){ selectAll.checked=false; selectAll.indeterminate=false; return; }
  const all = checkboxes.every(cb=>cb.checked);
  const some = checkboxes.some(cb=>cb.checked);
  selectAll.checked = all;
  selectAll.indeterminate = !all && some;
}

// helpers
function escapeHtml(text){ return text.replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]; }); }

 // Event listeners
searchInput.addEventListener('input',e=>{ query=e.target.value; currentPage=1; renderTable(); });
statusFilterEl.addEventListener('change',e=>{ statusFilter=e.target.value; currentPage=1; renderTable(); });
perPageEl.addEventListener('change',e=>{ perPage=parseInt(e.target.value); currentPage=1; renderTable(); });
sortSelect.addEventListener('change',e=>{
  const [k,dir]=e.target.value.split(':'); sortBy={key:k, dir:dir}; renderTable();
});
prevPageBtn.addEventListener('click',()=>{ if(currentPage>1){ currentPage--; renderTable(); } });
nextPageBtn.addEventListener('click',()=>{ const totalPages = Math.max(1,Math.ceil(getFilteredSorted().length/perPage)); if(currentPage<totalPages){ currentPage++; renderTable(); } });
selectAll.addEventListener('change',e=>{ document.querySelectorAll('.row-select').forEach(cb=>cb.checked=e.target.checked ? true:false); selectedIds = new Set(Array.from(document.querySelectorAll('.row-select')).filter(cb=>cb.checked).map(cb=>cb.dataset.id)); });

bulkDeleteBtn.addEventListener('click',()=>{
  if(selectedIds.size===0) return alert('No coupon selected');
  if(confirm('Delete selected coupons?')){
    coupons = coupons.filter(c=>!selectedIds.has(c.id));
    selectedIds.clear();
    renderTable();
  }
});

exportCSVBtn.addEventListener('click',()=>{
  let csv = 'Code,Discount,Start Date,End Date,Status,Description\n';
  getFilteredSorted().forEach(c=>{
    csv += `"${c.code}","${c.discount||''}","${c.startDate||''}","${c.endDate||''}","${c.isActive?'Active':'Inactive'}","${c.description||''}"\n`;
  });
  const blob = new Blob([csv],{type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='coupons.csv'; a.click(); URL.revokeObjectURL(url);
});

renderTable();
</script>
</body>
</html>
