<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>

	<!-- Bootstrap (used by markup classes) -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
	<link rel="stylesheet" href="/css/Sidebar.css">
	<link rel="stylesheet" href="/css/coupon.css">
</head>

<body>
	<!-- Sidebar container -->
	<div id="sidebar-container"></div>

	<!-- Navbar container -->
	<div id="navbar-container"></div>

	<main class="main-content" id="main-content">
		<div class="app-shell">
			<div class="container-full">
				<div class="d-flex align-items-center justify-content-between mb-3">
					<h3 class="mb-0">Coupons</h3>
					<div class="d-flex gap-2">
						<button id="exportCSVBtn" class="btn btn-couponlist-custom">Export CSV</button>
					</div>
				</div>

				<!-- Controls -->
				<div class="card mb-3">
					<div class="card-body p-0">
						<div class="row g-2 align-items-center">
							<div class="col-md-6">
								<input id="searchInput" class="form-control custom"
									placeholder="Search by code or description...">
							</div>

							<div class="col-md-2">
								<select id="statusFilter" class="form-select custom">
									<option value="all">All status</option>
									<option value="active">Active</option>
									<option value="inactive">Inactive</option>
								</select>
							</div>

							<div class="col-md-2">
								<select id="perPage" class="form-select custom">
									<option value="5">5 / page</option>
									<option value="10" selected>10 / page</option>
									<option value="20">20 / page</option>
								</select>
							</div>

							<div class="col-md-2 d-flex justify-content-end align-items-center gap-2">
								<small class="small-muted">Sort:</small>
								<select id="sortSelect" class="form-select custom w-auto">
									<option value="code:asc">Code â†‘</option>
									<option value="code:desc">Code â†“</option>
								</select>
							</div>
						</div>
					</div>
				</div>

				<!-- Table -->
				<div class="card">
					<div class="card-body p-0">
						<!-- ðŸ‘‡ Add table-responsive wrapper -->
						<div class="table-responsive">
							<table class="custome-table table align-middle mb-0">
								<thead class="table-light">
									<tr>
										<th style="width:48px;">
											<label class="form-check custom-check select-all-checkbox"
												title="Select all">
												<input id="selectAll" type="checkbox">
											</label>
										</th>
										<th>Code</th>
										<th>Discount</th>
										<th class="desktop-only">Start Date</th>
										<th class="desktop-only">End Date</th>
										<th>Status</th>
										<th style="width:150px">Actions</th>
									</tr>
								</thead>
								<tbody id="tableBody"></tbody>
							</table>
						</div>
					</div>
				</div>

				<!-- Footer actions + pagination -->
				<div class="footer-actions">
					<div class="d-flex align-items-center gap-2">
						<button id="bulkDeleteBtn" class="btn btn-couponlist-custom">Delete Selected</button>
						<div id="resultCount" class="small-muted">0 results</div>
					</div>

					<div class="d-flex align-items-center gap-2">
						<button id="prevPage" class="btn btn-couponlist-custom btn-sm">Prev</button>
						<div id="pageInfo" class="px-2 small-muted"> 1 / 1</div>
						<button id="nextPage" class="btn btn-couponlist-custom btn-sm">Next</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Edit Coupon Modal -->
		<div class="modal fade" id="editCouponModal" tabindex="-1" aria-hidden="true">
			<div class="modal-dialog modal-lg modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Edit Coupon</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<form id="editCouponForm">
							<div class="mb-3">
								<label for="editCode" class="form-label">Code</label>
								<input type="text" class="form-control" id="editCode">
							</div>
							<div class="mb-3">
								<label for="editDiscount" class="form-label">Discount</label>
								<input type="text" class="form-control" id="editDiscount">
							</div>
							<div class="mb-3">
								<label for="editDescription" class="form-label">Description</label>
								<textarea class="form-control" id="editDescription"></textarea>
							</div>
							<div class="row g-2">
								<div class="col-md-6">
									<label for="editStartDate" class="form-label">Start Date</label>
									<input type="date" class="form-control" id="editStartDate">
								</div>
								<div class="col-md-6">
									<label for="editEndDate" class="form-label">End Date</label>
									<input type="date" class="form-control" id="editEndDate">
								</div>
							</div>
							<div class="mt-3">
								<label class="form-label">Status</label>
								<select class="form-select" id="editStatus">
									<option value="active">Active</option>
									<option value="inactive">Inactive</option>
								</select>
							</div>
						</form>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
						<button type="button" class="btn btn-primary" id="saveEditBtn">Save</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Confirmation Modal -->
		<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="confirmModalTitle">Confirm</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body" id="confirmModalBody">Are you sure?</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-couponlist-custom" data-bs-dismiss="modal">Cancel</button>
						<button type="button" class="btn btn-couponlist-custom" id="confirmModalOkBtn">Yes</button>
					</div>
				</div>
			</div>
		</div>
	</main>

	<!-- Overlay for mobile -->
	<div class="overlay"></div>

	<!-- Bootstrap JS bundle -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	<script src="/js/sidebar-loader.js"></script>
	<script src="/js/navbar-loader.js"></script>

	<script>
		let coupons = [
			{ id: 'CUP-001', code: 'FLAT100', discount: 'CAD $100', startDate: '2024-12-31', endDate: '2025-12-30', isActive: true, description: 'Flat CA$100 off on orders above CA$1000' },
			{ id: 'CUP-002', code: 'SUMMER25', discount: '25%', startDate: '2025-05-31', endDate: '2025-09-29', isActive: true, description: 'Summer collection discount' },
			{ id: 'CUP-003', code: 'WELCOME10', discount: '10%', startDate: '2023-12-31', endDate: '2026-12-30', isActive: false, description: 'New customer coupon' }
		];

		let query = '', statusFilter = 'all', perPage = 10, currentPage = 1, sortBy = { key: 'code', dir: 'asc' }, selectedIds = new Set();

		const tableBody = document.getElementById('tableBody');
		const searchInput = document.getElementById('searchInput');
		const statusFilterEl = document.getElementById('statusFilter');
		const perPageEl = document.getElementById('perPage');
		const sortSelect = document.getElementById('sortSelect');
		const resultCount = document.getElementById('resultCount');
		const pageInfo = document.getElementById('pageInfo');
		const prevPageBtn = document.getElementById('prevPage');
		const nextPageBtn = document.getElementById('nextPage');
		const selectAll = document.getElementById('selectAll');
		const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
		const exportCSVBtn = document.getElementById('exportCSVBtn');

		// ===== Bootstrap modal helper for confirm/action =====
		function showConfirm(message, callback) {
			const modalEl = document.getElementById('confirmModal');
			const modal = new bootstrap.Modal(modalEl);
			document.getElementById('confirmModalBody').textContent = message;

			const okBtn = document.getElementById('confirmModalOkBtn');
			// Remove old listeners
			okBtn.replaceWith(okBtn.cloneNode(true));
			const newOkBtn = document.getElementById('confirmModalOkBtn');
			newOkBtn.addEventListener('click', () => {
				callback();
				modal.hide();
			});

			modal.show();
		}

		// ===== Helper functions =====
		function formatDate(d) {
			if (!d) return 'â€”';
			const dt = new Date(d);
			if (isNaN(dt)) return d;
			return (dt.getMonth() + 1) + '/' + dt.getDate() + '/' + dt.getFullYear();
		}

		function escapeHtml(text) {
			return text.replace(/[&<>"']/g, function (m) {
				return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m];
			});
		}

		function getFilteredSorted() {
			const q = query.trim().toLowerCase();
			let arr = coupons.filter(c => {
				if (statusFilter === 'active' && !c.isActive) return false;
				if (statusFilter === 'inactive' && c.isActive) return false;
				if (!q) return true;
				return c.code.toLowerCase().includes(q) || (c.description && c.description.toLowerCase().includes(q));
			});

			arr.sort((a, b) => {
				const k = sortBy.key; const dir = sortBy.dir === 'asc' ? 1 : -1;
				const A = (a[k] || '').toString().toLowerCase();
				const B = (b[k] || '').toString().toLowerCase();
				if (A < B) return -1 * dir; if (A > B) return 1 * dir; return 0;
			});

			return arr;
		}

		// ===== Render table =====
		function renderTable() {
			const arr = getFilteredSorted();
			const total = arr.length;
			const totalPages = Math.max(1, Math.ceil(total / perPage));
			if (currentPage > totalPages) currentPage = totalPages;

			const start = (currentPage - 1) * perPage;
			const visible = arr.slice(start, start + perPage);

			tableBody.innerHTML = '';
			if (visible.length === 0) {
				tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">No coupons found.</td></tr>';
			} else {
				visible.forEach(c => {
					const tr = document.createElement('tr');
					tr.innerHTML = `
					<td>
					<label class="form-check custom-check" title="Select">
						<input class="row-select" data-id="${c.id}" type="checkbox" ${selectedIds.has(c.id) ? 'checked' : ''}>
					</label>
					</td>
					<td><div class="fw-semibold">${escapeHtml(c.code)}</div></td>
					<td>${escapeHtml(c.discount || 'â€”')}</td>
					<td class="desktop-only">${formatDate(c.startDate)}</td>
					<td class="desktop-only">${formatDate(c.endDate)}</td>
					<td><span class="${c.isActive ? 'badge-active' : 'badge-inactive'} badge-status cursor-pointer" data-id="${c.id}">${c.isActive ? 'Active' : 'Inactive'}</span></td>
					<td>
					<div class="d-flex gap-2">
						<button class="btn btn-sm btn-couponlist-custom btn-edit" data-id="${c.id}"><i class="bi bi-pencil-square"></i></button>
						<button class="btn btn-sm btn-couponlist-custom btn-delete" data-id="${c.id}"><i class="bi bi-trash3"></i></button>
					</div>
					</td>
				`;
					tableBody.appendChild(tr);
				});
			}

			// ===== Event listeners for rows =====
			document.querySelectorAll('.row-select').forEach(el => el.addEventListener('change', e => {
				const id = e.target.dataset.id;
				e.target.checked ? selectedIds.add(id) : selectedIds.delete(id);
				updateSelectAllCheckbox();
			}));

			document.querySelectorAll('.btn-delete').forEach(b => {
				b.addEventListener('click', () => {
					const id = b.dataset.id;
					showConfirm('Delete this coupon?', () => {
						coupons = coupons.filter(c => c.id !== id);
						selectedIds.delete(id);
						renderTable();
					});
				});
			});

			// ===== Edit modal =====
			document.querySelectorAll('.btn-edit').forEach(b => {
				b.addEventListener('click', () => {
					const id = b.dataset.id;
					const coupon = coupons.find(c => c.id === id);
					if (!coupon) return;
					document.getElementById('editCode').value = coupon.code;
					document.getElementById('editDiscount').value = coupon.discount || '';
					document.getElementById('editDescription').value = coupon.description || '';
					document.getElementById('editStartDate').value = coupon.startDate;
					document.getElementById('editEndDate').value = coupon.endDate;
					document.getElementById('editStatus').value = coupon.isActive ? 'active' : 'inactive';

					const modal = new bootstrap.Modal(document.getElementById('editCouponModal'));
					modal.show();

					document.getElementById('saveEditBtn').onclick = () => {
						coupon.code = document.getElementById('editCode').value;
						coupon.discount = document.getElementById('editDiscount').value;
						coupon.description = document.getElementById('editDescription').value;
						coupon.startDate = document.getElementById('editStartDate').value;
						coupon.endDate = document.getElementById('editEndDate').value;
						coupon.isActive = document.getElementById('editStatus').value === 'active';
						renderTable();
						modal.hide();
					};
				});
			});

			document.querySelectorAll('.badge-status').forEach(b => {
				b.addEventListener('click', () => {
					const id = b.dataset.id;
					coupons = coupons.map(c => c.id === id ? { ...c, isActive: !c.isActive } : c);
					renderTable();
				});
			});

			resultCount.textContent = `${total} results`;
			pageInfo.textContent = ` ${currentPage} / ${totalPages}`;
			prevPageBtn.disabled = currentPage <= 1;
			nextPageBtn.disabled = currentPage >= totalPages;
			updateSelectAllCheckbox();
		}

		function updateSelectAllCheckbox() {
			const checkboxes = Array.from(document.querySelectorAll('.row-select'));
			if (checkboxes.length === 0) { selectAll.checked = false; selectAll.indeterminate = false; return; }
			const all = checkboxes.every(cb => cb.checked);
			const some = checkboxes.some(cb => cb.checked);
			selectAll.checked = all;
			selectAll.indeterminate = !all && some;
		}

		// ===== Event listeners =====
		searchInput.addEventListener('input', e => { query = e.target.value; currentPage = 1; renderTable(); });
		statusFilterEl.addEventListener('change', e => { statusFilter = e.target.value; currentPage = 1; renderTable(); });
		perPageEl.addEventListener('change', e => { perPage = parseInt(e.target.value); currentPage = 1; renderTable(); });
		sortSelect.addEventListener('change', e => {
			const [k, dir] = e.target.value.split(':'); sortBy = { key: k, dir: dir }; renderTable();
		});
		prevPageBtn.addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderTable(); } });
		nextPageBtn.addEventListener('click', () => {
			const totalPages = Math.max(1, Math.ceil(getFilteredSorted().length / perPage));
			if (currentPage < totalPages) { currentPage++; renderTable(); }
		});
		selectAll.addEventListener('change', e => {
			document.querySelectorAll('.row-select').forEach(cb => cb.checked = e.target.checked);
			selectedIds = new Set(Array.from(document.querySelectorAll('.row-select')).filter(cb => cb.checked).map(cb => cb.dataset.id));
		});

		bulkDeleteBtn.addEventListener('click', () => {
			if (selectedIds.size === 0) {
				showConfirm('No coupon selected', () => { });
				return;
			}
			showConfirm('Delete selected coupons?', () => {
				coupons = coupons.filter(c => !selectedIds.has(c.id));
				selectedIds.clear();
				renderTable();
			});
		});

		exportCSVBtn.addEventListener('click', () => {
			let csv = 'Code,Discount,Start Date,End Date,Status,Description\n';
			getFilteredSorted().forEach(c => {
				csv += `"${c.code}","${c.discount || ''}","${c.startDate || ''}","${c.endDate || ''}","${c.isActive ? 'Active' : 'Inactive'}","${c.description || ''}"\n`;
			});
			const blob = new Blob([csv], { type: 'text/csv' });
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a'); a.href = url; a.download = 'coupons.csv'; a.click(); URL.revokeObjectURL(url);
		});

		renderTable();
	</script>

</body>

</html>