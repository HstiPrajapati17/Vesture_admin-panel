<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>

	<!-- Bootstrap (used by markup classes) -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
	<link rel="stylesheet" href="/css/Sidebar.css">
	<link rel="stylesheet" href="/css/coupon.css">

</head>

<body>
	<!-- Sidebar container -->
	<div id="sidebar-container"></div>

	<!-- Navbar container -->
	<div id="navbar-container"></div>

	<main class="main-content" id="main-content">
		<div class="app-shell">
			<div class="container-full">
				<div class="d-flex align-items-center justify-content-between mb-3">
					<h3 class="mb-0">Coupons</h3>
				</div>

				<!-- Controls -->
				<div class="card mb-3">
					<div class="card-body p-0">
						<div class="row g-2 align-items-center">

							<div class="col-md-2">
								<select id="statusFilter" class="form-select custom">
									<option value="all">All status</option>
									<option value="active">Active</option>
									<option value="inactive">Inactive</option>
								</select>
							</div>

							<div class="col-md-2 d-flex justify-content-md-start justify-content-end align-items-center gap-2">
								<small class="small-muted">Sort:</small>
								<select id="sortSelect" class="form-select custom w-auto">
									<option value="code:asc">Code ↑</option>
									<option value="code:desc">Code ↓</option>
								</select>
							</div>
						</div>
					</div>
				</div>

				<!-- Table -->
				<div class="card">
					<div class="card-body p-0">
						<div class="table-responsive">
							<table class="custome-table table align-middle mb-0">
								<thead class="table-light">
									<tr>
										<th style="width:48px;">
											<label class="form-check custom-check select-all-checkbox"
												title="Select all">
												<input id="selectAll" type="checkbox">
											</label>
										</th>
										<th>Code</th>
										<th>Discount</th>
										<th class="desktop-only">Start Date</th>
										<th class="desktop-only">End Date</th>
										<th>Status</th>
										<th style="width:150px">Actions</th>
									</tr>
								</thead>
								<tbody id="tableBody"></tbody>
							</table>
						</div>
					</div>
				</div>

				<!-- Footer actions + pagination -->
				<div class="footer-actions">
					<div class="d-flex align-items-center gap-2">
						<button id="bulkDeleteBtn" class="btn btn-couponlist-custom text-nowrap">Delete Selected</button>
						<div id="resultCount" class="small-muted d-none">0 results</div>
					</div>

					<div class="d-flex align-items-center  gap-2">
						<button id="prevPage" class="btn btn-couponlist-custom btn-sm">Prev</button>
						<div id="pageInfo" class="px-2 small-muted"> 1 / 1</div>
						<button id="nextPage" class="btn btn-couponlist-custom btn-sm">Next</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Custom Confirmation Modal -->
		<div class="custom-modal-overlay" id="customModalOverlay">
			<div class="custom-modal">
				<div class="custom-modal-header" id="customModalTitle">Confirm</div>
				<div class="custom-modal-body" id="customModalBody">Are you sure?</div>
				<div class="custom-modal-footer">
					<button class="custome_modal_btn" id="customModalCancel">Cancel</button>
					<button class="custome_modal_btn h_cstm_modal-btn" id="customModalOk">Yes</button>
				</div>
			</div>
		</div>
	</main>

	<!-- Overlay for mobile -->
	<div class="overlay"></div>

	<!-- Bootstrap JS bundle -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	<script src="/js/sidebar-loader.js"></script>
	<script src="/js/navbar-loader.js"></script>

	<script>
		let coupons = [
			{ id: 'CUP-001', code: 'FLAT100', discount: 'CAD $100', startDate: '2024-12-31', endDate: '2025-12-30', isActive: true, description: 'Flat CA$100 off on orders above CA$1000' },
			{ id: 'CUP-002', code: 'SUMMER25', discount: '25%', startDate: '2025-05-31', endDate: '2025-09-29', isActive: true, description: 'Summer collection discount' },
			{ id: 'CUP-003', code: 'WELCOME10', discount: '10%', startDate: '2023-12-31', endDate: '2026-12-30', isActive: false, description: 'New customer coupon' },
		];

		let statusFilter = 'all', sortBy = { key: 'code', dir: 'asc' }, selectedIds = new Set();

		const tableBody = document.getElementById('tableBody');
		const statusFilterEl = document.getElementById('statusFilter');
		const sortSelect = document.getElementById('sortSelect');
		const resultCount = document.getElementById('resultCount');
		const pageInfo = document.getElementById('pageInfo');
		const prevPageBtn = document.getElementById('prevPage');
		const nextPageBtn = document.getElementById('nextPage');
		const selectAll = document.getElementById('selectAll');
		const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');

		// Custom modal elements
		const customModalOverlay = document.getElementById('customModalOverlay');
		const customModalBody = document.getElementById('customModalBody');
		const customModalOk = document.getElementById('customModalOk');
		const customModalCancel = document.getElementById('customModalCancel');

		let currentPage = 1, perPage = 10;

		// ===== Custom modal helper =====
		function showConfirm(message, callback) {
			customModalBody.textContent = message;
			customModalOverlay.style.display = "flex";

			// Reset old listeners
			const newOk = customModalOk.cloneNode(true);
			customModalOk.parentNode.replaceChild(newOk, customModalOk);

			// Add fresh listener
			newOk.addEventListener("click", () => {
				callback();
				closeCustomModal();
			});

			// Cancel button
			customModalCancel.onclick = closeCustomModal;

			// Close modal when clicking outside
			customModalOverlay.onclick = (e) => {
				if (e.target === customModalOverlay) {
					closeCustomModal();
				}
			};
		}

		function closeCustomModal() {
			customModalOverlay.style.display = "none";
		}

		// ===== Helpers =====
		function formatDate(d) {
			if (!d) return '—';
			const dt = new Date(d);
			if (isNaN(dt)) return d;
			return (dt.getMonth() + 1) + '/' + dt.getDate() + '/' + dt.getFullYear();
		}

		function escapeHtml(text) {
			return text.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m]));
		}

		function getFilteredSorted() {
			let arr = coupons.filter(c => {
				if (statusFilter === 'active' && !c.isActive) return false;
				if (statusFilter === 'inactive' && c.isActive) return false;
				return true;
			});

			arr.sort((a, b) => {
				const k = sortBy.key; const dir = sortBy.dir === 'asc' ? 1 : -1;
				const A = (a[k] || '').toString().toLowerCase();
				const B = (b[k] || '').toString().toLowerCase();
				if (A < B) return -1 * dir; if (A > B) return 1 * dir; return 0;
			});
			return arr;
		}

		// ===== Render table =====
		function renderTable() {
			const arr = getFilteredSorted();
			const total = arr.length;
			const totalPages = Math.max(1, Math.ceil(total / perPage));
			if (currentPage > totalPages) currentPage = totalPages;

			const start = (currentPage - 1) * perPage;
			const visible = arr.slice(start, start + perPage);

			tableBody.innerHTML = '';
			if (visible.length === 0) {
				tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">No coupons found.</td></tr>';
			} else {
				visible.forEach(c => {
					const tr = document.createElement('tr');
					tr.innerHTML = `
					<td>
						<label class="form-check custom-check" title="Select">
							<input class="row-select" data-id="${c.id}" type="checkbox" ${selectedIds.has(c.id) ? 'checked' : ''}>
						</label>
					</td>
					<td><div class="fw-semibold">${escapeHtml(c.code)}</div></td>
					<td>${escapeHtml(c.discount || '—')}</td>
					<td class="desktop-only">${formatDate(c.startDate)}</td>
					<td class="desktop-only">${formatDate(c.endDate)}</td>
					<td><span class="${c.isActive ? 'badge-active' : 'badge-inactive'} badge-status cursor-pointer" data-id="${c.id}">${c.isActive ? 'Active' : 'Inactive'}</span></td>
					<td>
						<div class="d-flex gap-2">
							<button class="btn btn-sm btn-couponlist-custom btn-edit" data-id="${c.id}"><i class="bi bi-pencil-square"></i></button>
							<button class="btn btn-sm btn-couponlist-custom btn-delete" data-id="${c.id}"><i class="bi bi-trash3"></i></button>
						</div>
					</td>`;
					tableBody.appendChild(tr);
				});
			}

			// Row events
			document.querySelectorAll('.row-select').forEach(el => el.addEventListener('change', e => {
				const id = e.target.dataset.id;
				e.target.checked ? selectedIds.add(id) : selectedIds.delete(id);
				updateSelectAllCheckbox();
			}));

			document.querySelectorAll('.btn-delete').forEach(b => {
				b.addEventListener('click', () => {
					const id = b.dataset.id;
					showConfirm('Delete this coupon?', () => {
						coupons = coupons.filter(c => c.id !== id);
						selectedIds.delete(id);
						renderTable();
					});
				});
			});

			document.querySelectorAll('.btn-edit').forEach(b => {
				b.addEventListener('click', () => {
					const id = b.dataset.id;
					// redirect to add coupon page with query param
					window.location.href = `AddCoupon.html?edit=${id}`;
				});
			});

			document.querySelectorAll('.badge-status').forEach(b => {
				b.addEventListener('click', () => {
					const id = b.dataset.id;
					coupons = coupons.map(c => c.id === id ? { ...c, isActive: !c.isActive } : c);
					renderTable();
				});
			});

			resultCount.textContent = `${total} results`;
			pageInfo.textContent = ` ${currentPage} / ${totalPages}`;
			prevPageBtn.disabled = currentPage <= 1;
			nextPageBtn.disabled = currentPage >= totalPages;
			updateSelectAllCheckbox();
		}

		function updateSelectAllCheckbox() {
			const checkboxes = Array.from(document.querySelectorAll('.row-select'));
			if (checkboxes.length === 0) { selectAll.checked = false; selectAll.indeterminate = false; return; }
			const all = checkboxes.every(cb => cb.checked);
			const some = checkboxes.some(cb => cb.checked);
			selectAll.checked = all;
			selectAll.indeterminate = !all && some;
		}

		// Event listeners
		statusFilterEl.addEventListener('change', e => { statusFilter = e.target.value; currentPage = 1; renderTable(); });
		sortSelect.addEventListener('change', e => { const [k, dir] = e.target.value.split(':'); sortBy = { key: k, dir: dir }; renderTable(); });
		prevPageBtn.addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderTable(); } });
		nextPageBtn.addEventListener('click', () => { const totalPages = Math.max(1, Math.ceil(getFilteredSorted().length / perPage)); if (currentPage < totalPages) { currentPage++; renderTable(); } });
		selectAll.addEventListener('change', e => {
			document.querySelectorAll('.row-select').forEach(cb => cb.checked = e.target.checked);
			selectedIds = new Set(Array.from(document.querySelectorAll('.row-select')).filter(cb => cb.checked).map(cb => cb.dataset.id));
		});

		bulkDeleteBtn.addEventListener('click', () => {
			if (selectedIds.size === 0) {
				showConfirm('No coupon selected', () => { });
				return;
			}
			showConfirm('Delete selected coupons?', () => {
				coupons = coupons.filter(c => !selectedIds.has(c.id));
				selectedIds.clear();
				renderTable();
			});
		});

		renderTable();
	</script>
</body>
</html>
