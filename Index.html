<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cloth Manufacturing Admin - Dashboard</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Font Awesome Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    body { background: #f7f9fc; }
    .kpi-icon { font-size: 1.6rem; opacity: .9; }
    .kpi-value { font-weight: 700; font-size: 1.5rem; }
    .small-muted { color: #6c757d; font-size: .85rem; }
    .progress-small { height: 8px; border-radius: 6px; }
    .table-lowstock td, .table-lowstock th { vertical-align: middle; }
    @media (max-width: 575px) {
      .kpi-value { font-size: 1.2rem; }
      .kpi-label { font-size: .9rem; }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="#">FabricFlow Admin</a>
      <div class="d-flex align-items-center">
        <div class="me-3 small-muted">Welcome, Admin</div>
        <button class="btn btn-outline-secondary btn-sm"><i class="fa fa-user"></i></button>
      </div>
    </div>
  </nav>

  <main class="container-fluid px-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h1 class="h4 mb-0">Dashboard</h1>
        <div class="small-muted">Overview of today's production & operations</div>
      </div>
      <div>
        <button class="btn btn-primary btn-sm" id="refreshBtn"><i class="fa fa-sync"></i> Refresh</button>
      </div>
    </div>

    <!-- KPI cards -->
    <div class="row g-3 mb-4">
      <div class="col-12 col-sm-6 col-md-4 col-lg-2">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="small-muted kpi-label">Today's Orders</div>
                <div class="kpi-value" id="kpi-orders">0</div>
                <div class="small-muted">New / In Progress</div>
              </div>
              <div class="text-end">
                <i class="fa fa-file-lines kpi-icon text-primary"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-sm-6 col-md-4 col-lg-2">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="small-muted kpi-label">Production Output</div>
                <div class="kpi-value" id="kpi-output">0</div>
                <div class="small-muted">Units / day</div>
              </div>
              <div class="text-end">
                <i class="fa fa-industry kpi-icon text-success"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-sm-6 col-md-4 col-lg-2">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="small-muted kpi-label">Pending GRNs</div>
                <div class="kpi-value" id="kpi-grn">0</div>
                <div class="small-muted">Awaiting receiving</div>
              </div>
              <div class="text-end">
                <i class="fa fa-truck-loading kpi-icon text-warning"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-sm-6 col-md-4 col-lg-2">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="small-muted kpi-label">Low Stock SKUs</div>
                <div class="kpi-value" id="kpi-lowstock">0</div>
                <div class="small-muted">Below reorder level</div>
              </div>
              <div class="text-end">
                <i class="fa fa-box-open kpi-icon text-danger"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-sm-6 col-md-4 col-lg-2">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="small-muted kpi-label">QC Rejects</div>
                <div class="kpi-value" id="kpi-qc">0</div>
                <div class="small-muted">Today</div>
              </div>
              <div class="text-end">
                <i class="fa fa-xmark-circle kpi-icon text-secondary"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-sm-6 col-md-4 col-lg-2">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="small-muted kpi-label">Shipments Due</div>
                <div class="kpi-value" id="kpi-shipments">0</div>
                <div class="small-muted">Next 72 hrs</div>
              </div>
              <div class="text-end">
                <i class="fa fa-box-truck kpi-icon text-info"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Row: Chart + Low stock list -->
    <div class="row g-4 mb-4">
      <div class="col-12 col-lg-8">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <h5 class="mb-0">Production Output (last 7 days)</h5>
                <div class="small-muted">Units produced per day</div>
              </div>
              <div class="small-muted">Target: <strong id="output-target">1200</strong> units/day</div>
            </div>
            <canvas id="productionChart" height="120"></canvas>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-4">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">Low stock SKUs</h6>
              <button class="btn btn-sm btn-outline-secondary" id="reorderBtn"><i class="fa fa-arrow-up-right-from-square"></i> Reorder</button>
            </div>

            <div class="table-responsive">
              <table class="table table-sm table-lowstock">
                <thead class="table-light">
                  <tr>
                    <th>SKU</th>
                    <th>Stock</th>
                    <th>Reorder</th>
                  </tr>
                </thead>
                <tbody id="lowstockBody">
                </tbody>
              </table>
            </div>
            <div class="mt-3 small-muted">Tip: reorder items with stock &lt; reorder level.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Extra charts row: QC pie, orders stage, throughput -->
    <div class="row g-4 mb-4">
      <div class="col-12 col-md-4">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <h6 class="mb-0">QC Defects Breakdown</h6>
              <div class="small-muted">Top reasons</div>
            </div>
            <canvas id="qcPieChart" height="160"></canvas>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-4">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <h6 class="mb-0">Orders by Stage (last 7 days)</h6>
              <div class="small-muted">Cutting → Stitching → Packing</div>
            </div>
            <canvas id="ordersStageChart" height="160"></canvas>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-4">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <h6 class="mb-0">Throughput Trend (last 14 days)</h6>
              <div class="small-muted">Daily units</div>
            </div>
            <canvas id="throughputLineChart" height="160"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Row: Recent orders & QC rejects -->
    <div class="row g-4 mb-5">
      <div class="col-12 col-lg-8">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="mb-0">Recent Orders</h6>
              <div>
                <button class="btn btn-outline-secondary btn-sm me-2" onclick="exportTableToCSV()">Export CSV</button>
                <button class="btn btn-outline-secondary btn-sm" id="viewAllOrders">View All</button>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-hover table-sm">
                <thead class="table-light">
                  <tr>
                    <th>Order ID</th>
                    <th>Customer</th>
                    <th>Qty</th>
                    <th>Stage</th>
                    <th>ETA</th>
                  </tr>
                </thead>
                <tbody id="recentOrdersBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">QC Rejects (today)</h6>
              <div class="small-muted" id="rejectRate">0%</div>
            </div>

            <div class="mb-3">
              <div class="small-muted">Rejects vs inspected</div>
              <div class="progress progress-small">
                <div class="progress-bar" id="rejectBar" role="progressbar" style="width:0%"></div>
              </div>
            </div>

            <div class="small-muted">Top failure reasons</div>
            <ul class="list-unstyled mt-2" id="qcReasons">
            </ul>
          </div>
        </div>
      </div>
    </div>

    <footer class="small-muted mb-5">
      <div class="text-center">© <span id="year"></span> FabricFlow • Admin Panel</div>
    </footer>
  </main>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ---------- SAMPLE DATA (replace with real API calls) ----------
    const sample = {
      kpis: {
        orders: 58,
        output: 1120,
        grn: 6,
        lowstockCount: 7,
        qc: 3,
        shipments: 9,
        target: 1200
      },
      productionLast7: {
        labels: ['Aug 8', 'Aug 9', 'Aug 10', 'Aug 11', 'Aug 12', 'Aug 13', 'Aug 14'],
        values: [980, 1100, 1150, 1080, 1200, 1250, 1120]
      },
      lowstock: [
        { sku: 'FAB-001', stock: 18, reorder: 30 },
        { sku: 'TRM-200', stock: 3, reorder: 25 },
        { sku: 'ZIP-10', stock: 6, reorder: 15 },
        { sku: 'BTN-55', stock: 12, reorder: 20 }
      ],
      recentOrders: [
        { id: 'ORD-1001', customer: 'Alpha Apparels', qty: 150, stage: 'Cutting', eta: '2025-08-16' },
        { id: 'ORD-1002', customer: 'Zenith', qty: 80, stage: 'Stitching', eta: '2025-08-18' },
        { id: 'ORD-1003', customer: 'Starlit', qty: 200, stage: 'Packing', eta: '2025-08-15' }
      ],
      qc: {
        inspected: 420,
        rejects: 3,
        reasons: [
          { reason: 'Stitch defect', count: 2 },
          { reason: 'Color mismatch', count: 1 }
        ]
      },
      // extra charts data
      qcBreakdown: [
        { reason: 'Stitch defect', count: 12 },
        { reason: 'Color mismatch', count: 7 },
        { reason: 'Measurement error', count: 4 },
        { reason: 'Fabric flaw', count: 6 }
      ],
      ordersByStage: {
        labels: ['Aug 8','Aug 9','Aug 10','Aug 11','Aug 12','Aug 13','Aug 14'],
        stages: {
          Cutting: [30,40,35,25,45,50,20],
          Stitching: [25,30,40,35,30,45,30],
          Packing: [20,15,18,22,16,20,25],
          Shipped: [10,8,12,15,20,10,18]
        }
      },
      throughput: {
        labels: ['Jul 31','Aug 1','Aug 2','Aug 3','Aug 4','Aug 5','Aug 6','Aug 7','Aug 8','Aug 9','Aug10','Aug11','Aug12','Aug13'],
        values: [900,980,1100,1050,1150,1200,1220,1100,1150,1180,1210,1190,1250,1120],
        target: 1200
      }
    };

    // ---------- DOM population ----------
    function populateKPIs(data) {
      document.getElementById('kpi-orders').textContent = data.kpis.orders;
      document.getElementById('kpi-output').textContent = data.kpis.output;
      document.getElementById('kpi-grn').textContent = data.kpis.grn;
      document.getElementById('kpi-lowstock').textContent = data.kpis.lowstockCount;
      document.getElementById('kpi-qc').textContent = data.kpis.qc;
      document.getElementById('kpi-shipments').textContent = data.kpis.shipments;
      document.getElementById('output-target').textContent = data.kpis.target;
    }

    function populateLowStockTable(list) {
      const tbody = document.getElementById('lowstockBody');
      tbody.innerHTML = '';
      list.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${item.sku}</strong></td>
          <td>${item.stock}</td>
          <td>${item.reorder}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function populateRecentOrders(list) {
      const tbody = document.getElementById('recentOrdersBody');
      tbody.innerHTML = '';
      list.forEach(o => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${o.id}</td>
          <td>${o.customer}</td>
          <td>${o.qty}</td>
          <td><span class="badge bg-secondary">${o.stage}</span></td>
          <td>${o.eta}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function populateQC(qc) {
      const rate = qc.inspected ? Math.round((qc.rejects / qc.inspected) * 10000) / 100 : 0;
      document.getElementById('rejectRate').textContent = rate + '%';
      document.getElementById('rejectBar').style.width = Math.min(rate, 100) + '%';
      const list = document.getElementById('qcReasons');
      list.innerHTML = '';
      qc.reasons.forEach(r => {
        const li = document.createElement('li');
        li.innerHTML = `<strong>${r.reason}</strong> — ${r.count}`;
        list.appendChild(li);
      });
    }

    // ---------- Chart: production ----------
    let productionChart = null;
    function renderProductionChart(labels, values) {
      const ctx = document.getElementById('productionChart').getContext('2d');
      if (productionChart) productionChart.destroy();
      productionChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Units',
            data: values,
            borderRadius: 6,
            barThickness: 20
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: { mode: 'index', intersect: false }
          },
          scales: {
            x: { grid: { display: false } },
            y: { beginAtZero: true }
          }
        }
      });
    }

    // ---------- Extra charts ----------
    let qcPie = null;
    function renderQCPie(breakdown) {
      const ctx = document.getElementById('qcPieChart').getContext('2d');
      const labels = breakdown.map(x => x.reason);
      const data = breakdown.map(x => x.count);
      if (qcPie) qcPie.destroy();
      qcPie = new Chart(ctx, {
        type: 'pie',
        data: { labels, datasets: [{ data, borderWidth: 0 }] },
        options: { plugins: { legend: { position: 'bottom' } } }
      });
    }

    let ordersStageChart = null;
    function renderOrdersStage(obj) {
      const ctx = document.getElementById('ordersStageChart').getContext('2d');
      const labels = obj.labels;
      const datasets = Object.keys(obj.stages).map((k, i) => ({
        label: k,
        data: obj.stages[k],
        stack: 'stages'
      }));
      if (ordersStageChart) ordersStageChart.destroy();
      ordersStageChart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets },
        options: {
          plugins: { legend: { position: 'bottom' } },
          responsive: true,
          scales: {
            x: { stacked: true },
            y: { stacked: true, beginAtZero: true }
          }
        }
      });
    }

    let throughputLineChart = null;
    function renderThroughput(labels, values, target) {
      const ctx = document.getElementById('throughputLineChart').getContext('2d');
      if (throughputLineChart) throughputLineChart.destroy();
      throughputLineChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'Units produced', data: values, fill: false, tension: 0.2 },
            { label: 'Target', data: new Array(values.length).fill(target), borderDash: [6,4], pointRadius: 0 }
          ]
        },
        options: {
          plugins: { legend: { position: 'bottom' } },
          scales: { y: { beginAtZero: false } }
        }
      });
    }

    function populateExtraCharts() {
      renderQCPie(sample.qcBreakdown);
      renderOrdersStage(sample.ordersByStage);
      renderThroughput(sample.throughput.labels, sample.throughput.values, sample.throughput.target);
    }

    // ---------- Export CSV helper ----------
    function exportTableToCSV(filename = 'recent_orders.csv') {
      const rows = [];
      const trs = document.querySelectorAll('#recentOrdersBody tr');
      // header
      rows.push(['Order ID','Customer','Qty','Stage','ETA']);
      trs.forEach(tr => {
        const cols = Array.from(tr.children).map(td => td.textContent.trim());
        rows.push(cols);
      });
      const csvContent = rows.map(r => r.map(c => `"${c.replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    }

    // ---------- Refresh / init ----------
    function refreshDashboard() {
      // Replace this function's internals with fetch() calls to your APIs in production.
      populateKPIs(sample);
      populateLowStockTable(sample.lowstock);
      populateRecentOrders(sample.recentOrders);
      populateQC(sample.qc);
      renderProductionChart(sample.productionLast7.labels, sample.productionLast7.values);
      populateExtraCharts();
      document.getElementById('year').textContent = new Date().getFullYear();
    }

    // ---------- small UI hooks ----------
    document.addEventListener('DOMContentLoaded', () => {
      refreshDashboard();
      document.getElementById('refreshBtn').addEventListener('click', refreshDashboard);
      document.getElementById('reorderBtn').addEventListener('click', () => {
        alert('Open Reorder workflow (wire to real UI/API).');
      });
      document.getElementById('viewAllOrders').addEventListener('click', () => {
        alert('Navigate to Orders page (implement routing).');
      });
    });

    // ---------- OPTIONAL: expose methods for dev console ----------
    window._dashboard = {
      refresh: refreshDashboard,
      exportCSV: exportTableToCSV
    };
  </script>
</body>
</html>
